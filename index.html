<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Neon Dodge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #0f2027, #000);
      color: #fff;
      font-family: system-ui, sans-serif;
      overflow: hidden;
      touch-action: none;
    }
    canvas { display: block; }
    #ui { position: fixed; top: 16px; left: 16px; font-size: 14px; opacity: 0.9; }
    #center { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; text-align: center; pointer-events: none; }
    button { pointer-events: auto; background: #00f5ff; color: #000; border: none; border-radius: 8px; padding: 12px 18px; font-size: 16px; cursor: pointer; box-shadow: 0 0 20px #00f5ff55; }
    #joystick {
      position: fixed;
      bottom: 40px;
      left: 40px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255,255,255,0.08);
      display: none;
    }
    #stick {
      position: absolute;
      inset: 35px;
      border-radius: 50%;
      background: rgba(0,245,255,0.8);
    }
    #soundToggle { position: fixed; top: 16px; right: 16px; }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="joystick"><div id="stick"></div></div>
  <button id="soundToggle">ðŸ”Š</button>

  <div id="ui">
    <div>Score: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>

  <div id="center">
    <div id="menu">
      <h1>NEON DODGE</h1>
      <p>Dodge the incoming energy orbs.<br/>Keyboard, joystick, or tap to move.</p>
      <button id="start">Start Game</button>
    </div>
  </div>

<script>
// ---------- SETUP ----------
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
const startBtn = document.getElementById('start');
const menu = document.getElementById('menu');
const soundToggle = document.getElementById('soundToggle');
const joystick = document.getElementById('joystick');
const stick = document.getElementById('stick');

let w, h;
function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// ---------- INPUT ----------
let keys = {};
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

// Show joystick only on touch devices
if ('ontouchstart' in window) joystick.style.display = 'block';

let joyDX = 0, joyDY = 0;
joystick.addEventListener('touchmove', e => {
  e.preventDefault();
  const rect = joystick.getBoundingClientRect();
  const t = e.touches[0];
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  joyDX = Math.max(-1, Math.min(1, (t.clientX - cx) / 40));
  joyDY = Math.max(-1, Math.min(1, (t.clientY - cy) / 40));
  stick.style.transform = `translate(${joyDX * 20}px, ${joyDY * 20}px)`;
}, { passive: false });

joystick.addEventListener('touchend', () => {
  joyDX = joyDY = 0;
  stick.style.transform = 'translate(0,0)';
});

// Tap-to-move & dash
let tapTarget = null;
let lastTap = 0;
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  const now = Date.now();
  const t = e.touches[0];
  tapTarget = { x: t.clientX, y: t.clientY };

  if (now - lastTap < 300) dash();
  lastTap = now;
}, { passive: false });

// ---------- AUDIO ----------
let soundOn = true;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq, dur = 0.1) {
  if (!soundOn) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value = freq;
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
  o.stop(audioCtx.currentTime + dur);
}

soundToggle.onclick = () => {
  soundOn = !soundOn;
  soundToggle.textContent = soundOn ? 'ðŸ”Š' : 'ðŸ”‡';
};

// ---------- GAME STATE ----------
let bestScore = Number(localStorage.getItem('neon-best') || 0);
bestEl.textContent = bestScore;

let player, enemies, score, running;
let dashCooldown = 0;

function reset() {
  player = { x: w/2, y: h/2, r: 10, speed: 5 };
  enemies = [];
  score = 0;
  dashCooldown = 0;
}

function dash() {
  if (dashCooldown > 0) return;
  player.x += joyDX * 80;
  player.y += joyDY * 80;
  dashCooldown = 60;
  navigator.vibrate?.(100);
  beep(600, 0.08);
}

function spawnEnemy() {
  const edge = Math.floor(Math.random() * 4);
  let x, y;
  if (edge === 0) { x = Math.random() * w; y = -20; }
  if (edge === 1) { x = w + 20; y = Math.random() * h; }
  if (edge === 2) { x = Math.random() * w; y = h + 20; }
  if (edge === 3) { x = -20; y = Math.random() * h; }
  const a = Math.atan2(player.y - y, player.x - x);
  enemies.push({ x, y, vx: Math.cos(a)*2.2, vy: Math.sin(a)*2.2, r: 8 });
  beep(300, 0.05);
}

// ---------- LOOP ----------
function update() {
  if (!running) return;

  if (dashCooldown > 0) dashCooldown--;

  if (tapTarget) {
    const dx = tapTarget.x - player.x;
    const dy = tapTarget.y - player.y;
    const d = Math.hypot(dx, dy);
    if (d > 5) {
      player.x += dx / d * player.speed;
      player.y += dy / d * player.speed;
    }
  }

  player.x += joyDX * player.speed;
  player.y += joyDY * player.speed;

  if (keys['w'] || keys['ArrowUp']) player.y -= player.speed;
  if (keys['s'] || keys['ArrowDown']) player.y += player.speed;
  if (keys['a'] || keys['ArrowLeft']) player.x -= player.speed;
  if (keys['d'] || keys['ArrowRight']) player.x += player.speed;

  player.x = Math.max(player.r, Math.min(w - player.r, player.x));
  player.y = Math.max(player.r, Math.min(h - player.r, player.y));

  enemies.forEach(e => { e.x += e.vx; e.y += e.vy; });

  for (const e of enemies) {
    if (Math.hypot(e.x - player.x, e.y - player.y) < e.r + player.r) {
      navigator.vibrate?.(200);
      gameOver();
      return;
    }
  }

  score++;
  scoreEl.textContent = score;
  if (score % 60 === 0) spawnEnemy();
}

function draw() {
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,w,h);

  ctx.beginPath();
  ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
  ctx.fillStyle = '#00f5ff';
  ctx.shadowBlur = 20;
  ctx.shadowColor = '#00f5ff';
  ctx.fill();
  ctx.shadowBlur = 0;

  enemies.forEach(e => {
    ctx.beginPath();
    ctx.arc(e.x, e.y, e.r, 0, Math.PI*2);
    ctx.fillStyle = '#ff0055';
    ctx.fill();
  });
}

function loop() {
  update(); draw(); requestAnimationFrame(loop);
}

function gameOver() {
  running = false;
  menu.style.display = 'block';
  if (score > bestScore) {
    bestScore = score;
    localStorage.setItem('neon-best', bestScore);
    bestEl.textContent = bestScore;
  }
}

startBtn.onclick = () => {
  reset(); running = true; menu.style.display = 'none';
};

// ---------- BASIC TEST ----------
console.assert(typeof dash === 'function', 'Dash function exists');
console.assert(player === undefined || typeof reset === 'function', 'Reset exists');

reset(); loop();
</script>
</body>
</html>
